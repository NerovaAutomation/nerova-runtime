<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#0b0f19" />
  <title>Playwright OCR Helper</title>
  <style>
    :root {
      --bg: #0b0f19;
      --panel: #0f1426;
      --text: #eaeef9;
      --muted: #aab3d6;
      --border: #27304a;
      --input: #141a2d;
      --input-focus: #1b2540;
      --accent: #2a3cff;
      --accent-600: #2335d9;
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); margin:0; }
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 18px; color: var(--text); }
    .row { display:flex; gap:8px; align-items:center; margin:6px 0; }
    input, button, select { padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--input); color:var(--text); }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); background: var(--input-focus); }
    input[type="url"], input[type="text"] { flex:1; }
    button { background:var(--accent); border-color:var(--accent); cursor:pointer; color: #fff; }
    button:hover { background: var(--accent-600); border-color: var(--accent-600); }
    pre { background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:8px; max-height:360px; overflow:auto; color: var(--text); }
    .cols { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .hint { opacity:.8; font-size:12px; color: var(--muted); }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #1f2a44; border-radius: 8px; border: 2px solid var(--bg); }
    ::-webkit-scrollbar-thumb:hover { background: #2a3a5f; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Playwright OCR Helper</h1>
    <div class="row">
      <input id="url" type="url" placeholder="https://... navigate" />
      <button id="btnGo">Go</button>
      <input id="apiKey" type="password" placeholder="OCR.space API key (helloworld demo)" style="width:260px" />
      <select id="language">
        <option value="eng">eng</option>
        <option value="spa">spa</option>
        <option value="fra">fra</option>
        <option value="deu">deu</option>
        <option value="ita">ita</option>
        <option value="por">por</option>
        <option value="jpn">jpn</option>
        <option value="kor">kor</option>
        <option value="chi_sim">chi_sim</option>
      </select>
      <button id="btnOcr">OCR screen â†’ JSON</button>
      <button id="btnOpenDashboard">Open Nerova Dashboard</button>
    </div>

    <div class="row">
      <input id="pageX" type="number" placeholder="page X" />
      <input id="pageY" type="number" placeholder="page Y" />
      <button id="btnClick">Click (page)</button>
      <span class="hint">Use OCR output click.page.x/y across iframes</span>
    </div>

    <div class="cols">
      <div>
        <h3>OCR results</h3>
        <div class="row">
          <input id="ocrFilter" type="search" placeholder="Filter OCR..." />
          <span id="ocrCount" class="hint"></span>
          <button id="btnCopyOcr">Copy JSON</button>
          <button id="btnResetOcr">Reset</button>
        </div>
        <pre id="out"></pre>
      </div>
      <div>
        <h3>Hittables</h3>
        <div class="row">
          <button id="btnHittables">Grab hittables</button>
        </div>
        <div class="row">
          <input id="hitsFilter" type="search" placeholder="Filter hittables..." />
          <span id="hitsCount" class="hint"></span>
          <button id="btnCopyHits">Copy JSON</button>
          <button id="btnResetHits">Reset</button>
        </div>
        <pre id="hits"></pre>
      </div>
    </div>
  </div>

  <script>
    const ws = new WebSocket(`ws://${location.host}`);
    const reqQ = new Map(); let seq = 1;
    ws.onmessage = (e) => {
      try { console.log('WS', e.data); } catch {}
      // naive: UI uses simple one-shot sends per button; not multiplexing
    };
    function send(obj){ ws.send(JSON.stringify(obj)); }

    // Persist key/language in localStorage
    const apiKeyInput = document.getElementById('apiKey');
    const langSelect = document.getElementById('language');
    const savedKey = localStorage.getItem('ocrApiKey');
    const savedLang = localStorage.getItem('ocrLanguage');
    if (savedKey) apiKeyInput.value = savedKey;
    if (savedLang) langSelect.value = savedLang;
    apiKeyInput.addEventListener('input', () => localStorage.setItem('ocrApiKey', apiKeyInput.value || ''));
    langSelect.addEventListener('change', () => localStorage.setItem('ocrLanguage', langSelect.value || 'eng'));

    document.getElementById('btnGo').onclick = () => {
      const url = document.getElementById('url').value.trim(); if(!url) return;
      send({ type: 'NAVIGATE', url });
    };
    document.getElementById('btnOcr').onclick = () => {
      const apiKey = apiKeyInput.value.trim() || 'helloworld';
      const language = langSelect.value || 'eng';
      fetch('/ws', { method:'POST' });
      send({ type: 'OCR_SCREEN_JSON', apiKey, language });
    };
    document.getElementById('btnOpenDashboard').onclick = () => {
      send({ type: 'NAVIGATE', url: 'https://dashboard.nerovaautomation.com' });
    };

    // Enter key on URL field triggers Go
    document.getElementById('url').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btnGo').click();
    });
    document.getElementById('btnClick').onclick = () => {
      const x = Number(document.getElementById('pageX').value || '');
      const y = Number(document.getElementById('pageY').value || '');
      if (!Number.isFinite(x) || !Number.isFinite(y)) return;
      send({ type: 'CLICK_PAGE', x, y });
    };
    document.getElementById('btnHittables').onclick = () => send({ type: 'GRAB_HITTABLES' });

    // Filtering/copy/reset for OCR and Hittables
    let lastOcr = [];
    let lastHits = [];
    function applyOcrFilter(){
      const q = (document.getElementById('ocrFilter').value || '').trim().toLowerCase();
      let filtered = lastOcr;
      if (q) filtered = lastOcr.filter(it => (it.text || '').toLowerCase().includes(q));
      document.getElementById('ocrCount').textContent = filtered.length ? String(filtered.length) : '';
      document.getElementById('out').textContent = JSON.stringify(filtered, null, 2) || '[]';
    }
    function applyHitsFilter(){
      const q = (document.getElementById('hitsFilter').value || '').trim().toLowerCase();
      let filtered = lastHits;
      if (q) filtered = lastHits.filter(it => {
        try { return [it.name, it.role, it.selector, it.href].filter(Boolean).join(' ').toLowerCase().includes(q); } catch { return false; }
      });
      document.getElementById('hitsCount').textContent = filtered.length ? String(filtered.length) : '';
      document.getElementById('hits').textContent = JSON.stringify(filtered, null, 2) || '[]';
    }
    document.getElementById('ocrFilter').addEventListener('input', applyOcrFilter);
    document.getElementById('hitsFilter').addEventListener('input', applyHitsFilter);
    document.getElementById('btnCopyOcr').onclick = async () => {
      const txt = document.getElementById('out').textContent || '';
      if (!txt.trim()) return; await navigator.clipboard.writeText(txt);
    };
    document.getElementById('btnCopyHits').onclick = async () => {
      const txt = document.getElementById('hits').textContent || '';
      if (!txt.trim()) return; await navigator.clipboard.writeText(txt);
    };
    document.getElementById('btnResetOcr').onclick = () => { document.getElementById('ocrFilter').value = ''; lastOcr = []; applyOcrFilter(); };
    document.getElementById('btnResetHits').onclick = () => { document.getElementById('hitsFilter').value = ''; lastHits = []; applyHitsFilter(); };

    // Extra controls, matching extension features
    // Create buttons row dynamically
    (function addExtraButtons(){
      const wrap = document.querySelector('.wrap');
      const h = document.createElement('h3'); h.textContent = 'Icons, Toggles, and Candidates'; wrap.appendChild(h);
      const row = document.createElement('div'); row.className='row'; row.style.flexWrap='wrap'; row.style.gap='8px'; wrap.appendChild(row);
      function addBtn(id, label, handler){ const b = document.createElement('button'); b.id=id; b.textContent=label; b.onclick=handler; row.appendChild(b); }
      const apiKey = () => document.getElementById('apiKey').value.trim() || 'helloworld';
      const lang = () => document.getElementById('language').value || 'eng';
      addBtn('btnFindIcons','Find icons',()=>send({ type:'FIND_ICONS', options:{ highlight:true }}));
      addBtn('btnHighlightHittable','Highlight hittable',()=>send({ type:'FIND_HITTABLE', options:{ highlight:true }}));
      addBtn('btnHighlightIframes2','Highlight iframes',()=>send({ type:'HIGHLIGHT_IFRAMES', options:{ highlight:true }}));
      addBtn('btnHighlightToggles2','Highlight toggles/menus',()=>send({ type:'HIGHLIGHT_TOGGLES', options:{ highlight:true }}));
      addBtn('btnDiscoverToggle2','Discover toggle',()=>send({ type:'HIGHLIGHT_TOGGLES', options:{ discover:true }}));
      addBtn('btnGrabText','Grab text',()=>send({ type:'GRAB_HITTABLE_TEXTS', options:{} }));
      addBtn('btnAccessibleNames','Accessible names',()=>send({ type:'GRAB_ACCESSIBLE_NAMES', options:{} }));
      addBtn('btnOcrIframes','OCR iframes (viewport)',()=>send({ type:'OCR_IFRAMES_VIEWPORT_JSON', apiKey: apiKey(), language: lang() }));
      addBtn('btnIconVisual','Icon visual recognition',()=>send({ type:'ICON_VISUAL_RECOGNITION', options:{ onlyIframes:true } }));
      addBtn('btnGrabCandidates','Grab filtered candidates',()=>send({ type:'GRAB_HITTABLE_CANDIDATES', options:{} }));
      addBtn('btnGrabCandidateStrings','Grab candidate strings',()=>send({ type:'GRAB_CANDIDATE_STRINGS', options:{} }));
      const pre = document.createElement('pre'); pre.id='log'; pre.className='hint'; wrap.appendChild(pre);
    })();

    // simple log
    ws.addEventListener('message', (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.items) { lastOcr = msg.items; applyOcrFilter(); }
        if (msg.elements) { lastHits = msg.elements; applyHitsFilter(); }
        if (msg.icons) document.getElementById('log').textContent = JSON.stringify(msg.icons, null, 2);
        if (msg.candidates) document.getElementById('log').textContent = JSON.stringify({ candidates: msg.candidates }, null, 2);
        if (msg.type === 'NAVIGATED') {
          // show a tiny preview to confirm navigation happening
          const out = document.getElementById('out');
          out.textContent = JSON.stringify({ ok: true, url: msg.url }, null, 2);
        }
      } catch {}
    });
  </script>
</body>
</html>
